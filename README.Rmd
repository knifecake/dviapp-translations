---
title: 'Disaster Victim Identification app: dviapp'
author: "Thore & Lourdes"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  pdf_document: default
  html_document:
    code_folding: hide
  word_document: default
  github_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(results='hold', message = FALSE, fig.path = "figures/",
                      fig.show = "hold", fig.align = "center", dev = "png")
```

# DVI (Disaster Victim Identification) app

This app deals with Disaster Victim Identification (DVI) problems and power 
calculation for kinship problems. Our goal has been to make  available functionality
in the [`pedsuite`](https://magnusdv.github.io/pedsuite/) of R libraries and also the 
`dvir` library. There are several built-in examples. Users can run run their own examples by
uploading [Familias](https://www.familias.no) files or data on R format.

There are tree modules:

* power: Simulations can be done to determine if goals are likely to be achieved.
* priority: The aim is to find the optimal extra persons to genotype.
* DVI: Methods to include or exclude missing persons are provided.

These models are explained and exemplified below.
For more information, check the books: 
[Mass identications](https://www.elsevier.com/books/mass-identifications/kling/978-0-12-818423-3)
(Kling et al., 2021),
[Pedigree Analysis in R](https://www.elsevier.com/books/pedigree-analysis-in-r/vigeland/978-0-12-824430-2) 
(Vigeland, 2021), and the
[dvir paper](https://www.nature.com/articles/s41598-021-93071-5)
(Vigeland and Egeland, 2021). For further documentation and bug reporting, please go
[here](https://github.com/thoree/dviapp).

## Power

Power calculations are generally performed prior to the actual analysis
to determine if there is sufficient data to reach conclusions.
The may detect that there is not sufficient information
or data, i.e., we are not likely to reach reliable conclusions.
In this case more data is needed, either more markers or
more genotyped reference individuals. This is explored in the Prioritise module. 
We consider two hypotheses

* $H_1$: The Person Of Interest (POI) is the Missing Person (MP).
* $H_2$: POI is unrelated to MP.

The hypotheses are illustrated below.

```{r, echo = F,  fig.height = 4, fig.width = 8, out.width = "80%", fig.align = "center"}
  source("R/helpers.R")
  library(dvir, quietly = T)
  library(forrel)
  x = nuclearPed(2, father = "FA", mother ="MO", children = c("MP", "REF"))
  missingPersonPlot(x, missing = "MP", frames = T, fmar = 0.02)
```  

Marker data is simulated a specified number times (default is 100) for POI and the references (in
the figure above there is only one reference). This is done conditionally
on genotyped individuals, above there are none. These simulations are done
assuming $H_1$ to be true, i.e., assuming that POI is MP. For each
of these simulations the LR is calculated. This gives 
values $LR_1, \ldots, LR_{100}$. The app produces the plot:

```{r, echo = F,  fig.height = 4, fig.width = 8, out.width = "80%", fig.align = "center", cache = T}
pedPower(x, nsim = 100, seed = 1729, lastMarker = 22,
   ids = c("MP", "REF"), plotOnly = FALSE, Log10 = TRUE)
```

The left panel shows that the expected $log_{10}(LR) = 6.24$,
which corresponds to expected LR equal to 1737801.
From the panel on the right hand side, we see that $log_{10}(LR)$
exceeds 3.89 with probability 0.8, or equivalently
$LR$ exceeds 7762 with probability 0.8. If the threholds 10,000 is used,
the power is not quite satisfactory.

### Analyses based on built in cases

For the built-in part, 35 markers from the `NorwegianFrequency'
(available in R library forrel) are used. Above the 22 first markers are used.
Power can be increased by using more markers
or genotyping more family members. If the number of markers is increased to 25 in the app,
the threshold of 10,000 is met.

Greater accuracy, at the cost increased conmputational time, is obtained by
increasing the number of simulations in `Settings`.
To obtain the same sequence of simulations, and the same result, the `Seed`in the
`Settings`need to be set to same value

### Analyses based on user loaded data

The analyses in this window is the same as explained above. The difference
is that the data is now loaded from a [Familias](https://www.familias.no).
The file is created on beforehand in the main module of Familias, not the DVI module.
The missing person need to be named `MP` and the reference `REF`. These individuals
are not genotyped. There may be genotyped  individuals. If so, these will be conditioned on
in the simulation. The genotyped individuals will be hatched in the plot and the first
marker displayed.

By default mutations are switched off. However, mutation can be turned
on in `Settings`.

## Prioritise

The typical scenario for this functionality is as follows: A power calculation has
been performed. The conclusion is that more individuals need to be genotyped
in the hope of reaching sufficient power.
We consider alternatives where extra family members `E1`and `E2` are available.
Results are reported when `E1` is genotyped and bot `E1` and `E2`. 
In addition to LR distribution described prveviously, results are also given for
the `Exclusion probability` (EP).

![Prioritise plot](C:/Users/theg/Dropbox/Rlibs/dviapp/figures/priRMD.png)

Consider first the panel on the left hand side.
The Y-axis gives the inclusion power (IP) defined as the probability that
LR exceeds 10,000 given that $H_1$, i.e., `MP = POI` is true.
If only the member `REF`of the the reference family is genotyped, IP is close to 0.8.
For both other alternatives, `E1`, `E1, E2` genotyped, IP is very close to 1.
The Y-axis in the panel to the right, shows that the alternative `E1,E2` is more powerful. The x-axes gives information on `EP`. The baseline alternative with only 
`REF` genotyped gives the values 0 in both plots. This is obvious, since exclusion
is not possible if only one brother is genotyped since brothers need to share alleles.
If additional brothers are genotyped, exclusion is probable and also likely as evidenced by EP in the plot to the left and by the expected number of exclusions to the right.


As for the `Power` module, simulations can be done either for built-in-cases or
by loading a Familias file.

## DVI

Also in this module, analyses can be donefrom built in cases, from Familias (`fam`)
files In addition R-data can be loaded provided they are on the same format
as the example cases in R library. The below figure shows the `planecrash data. 

![Planecrash example](C:/Users/theg/Dropbox/Rlibs/dviapp/figures/planecrash.png)
there are 8 female victims, to left, atched since they are genotyped. To the right there are
five reference families, each having one missing person (in red) and one reference family member
(in blue). In the following sections, we explain what can be calculated

### IBD estimates

The pairwise relationship between all pairs of victims is estimated
and compared to unrelated. Here's an example based on the `planecrash` data

```{r, echo = F, cache = T}
IBDestimates(planecrash$pm)[1:5,]
```

There $7\cdot 8/2 = 28$ pairwise comparisons that can be made between the 8 victions. Above, five are listed,sorted according to decreasing LR.
The parameters describing the pairwise relationship is estimated
as (k0 = 0.14, k1 = 0.56, k2= 0.30). This is quite far from the parameters
describing unrelated individuals, (k0 = 1, k1 = 0, k2 = 0).
The LR tests the estimated relationship against unrelated.
In this case, $LR = 737562$, and thisprovides stong evidence in favorof V7 and V8 being related, possibly full siblings.

 
### Exclusion

Each victim is tried in each missing person position
and the number of exclusions are counted. The results is summarised
in the `exclusion matrix` as exemplified based on the `planecrash` data below.

```{r, echo = F, cache = T}
exclusionMatrix(planecrash$pm, planecrash$am, planecrash$missing)
```

We see that families 2 and 5 do not allow for exclusions as only a sibling has been genotyped.The corresponding columns there only contain 0-s.
Each victim is tried as each missing person and the number 
of exclusions is given.
Furthermore, we see that the only likely candidate for M1 is V1,
since forthe other victims there are at least two exclusions.

### Pairwise LR

For each victim V and each missing person M, the LR comparing `V = M` to `V and M unrelated` is calculated. Here's the example based on
the `planecrash`data:

```{r, echo = F, cache = T}
pr = pairwiseLR(planecrash$pm, planecrash$am, planecrash$missing)$LRmatrix
pr
```

A mutation model has been defined (the proportionalwith rate = 0.001)
and so no likelihood ratios vanish.
We see that the only candidate for the missing person M1 is V1, the LR
is 925, all other LR-s are close to 0.
If mutations are removed, we get

```{r, echo = F, cache = T}
pr = pairwiseLR(setMutationModel(planecrash$pm, "trivial"),
    setMutationModel(planecrash$am, "trivial"), 
    planecrash$missing)$LRmatrix
pr
```


### Joint 

All possible assignments of victims to missing, are evaluated and solutions ranked according to the likelihood.

### Posterior

Computes posterior pairing and non-pairing probabilities, based on a prior and the output from `Joint`.


## Settings 

Data summary and plot does not requiring relabeling of data. However,
other functionality does when input is a Familias file. The reason is that
all missing persons have the same name in the fam file.

## No of missing...

If any reference family contains more than one missing, the total number
of missing must be given here. Also, in this case the missing persons should be named M1, ..., Mn in the Familias file.

## Download DVI table output

The indicated output is downloaded to a csv file called tab.csv.

